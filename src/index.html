<html>
    <head>
        <title>Codebox</title>
        <style>
        body {
            position: fixed;
            top: 0px;
            bottom: 0px;
            left: 0px;
            right: 0px;
            margin: 0px;
            padding: 0px;
            border: 0px;
        }
        iframe {
            width: 100%;
            height: 100%;
            margin: 0px;
            padding: 0px;
            border: 0px;
        }
        </style>
    </head>
    <body>
        <input type="file" id="fileDialog" nwdirectory style="display: none;"/>
    </body>
    <script>
    var Q = require("q");
    var codebox = require("codebox");
    var harbor = require("harbor");
    var gui = require('nw.gui');

    var win = gui.Window.get();
    var ports = new harbor(19000, 20000);

    var start = function(folder) {
        var url;

        console.log("start codebox on", folder);
        return Q.nfcall(ports.claim.bind(ports), "codebox")
        .then(function(port) {
            url = "http://localhost:"+port;

            return codebox.start({
                'port': port,
                'root': folder
            });
        })
        .then(function() {
            console.log("\n\n\n\n\n\n\n\n!!!!done !\n\n\n\n\n\n\n\n\n\n\n\n");
            document.body.innerHTML = "<iframe src='"+url+"' nwdisable nwfaketop></iframe>";

            win.show();
            win.focus();
            win.resizeTo(1000, 600);
            win.maximize();
        })
        .fail(console.log.bind(console));
    };

    var chooser = document.querySelector("#fileDialog");
    chooser.addEventListener("change", function(evt) {
        console.log("folder", this.value);
        start(this.value);
    }, false);
    chooser.click();
    </script>
</html>